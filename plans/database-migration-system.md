# CCDash データベースマイグレーションシステム開発計画

## 概要

CCDashプロジェクトにおいて、今後のバージョンアップに伴うデータベーススキーマ変更を管理する自動マイグレーションシステムを構築する。

## 現状分析

### 現在のスキーマ管理方法

1. **初期化時の一括作成**
   - `backend/internal/database/db.go`の`createTables()`関数で全テーブルを作成
   - `CREATE TABLE IF NOT EXISTS`で既存テーブルを保護
   - `ALTER TABLE ADD COLUMN IF NOT EXISTS`で新カラム追加

2. **手動マイグレーションツール**
   - `backend/cmd/migrate-*`配下に個別のマイグレーションコマンド
   - 各コマンドは特定のマイグレーション処理を実行
   - 実行順序や履歴管理の仕組みなし

3. **SQLファイル**
   - `backend/migrations/`にSQLファイルが存在するが、自動実行されない
   - ドキュメント目的で使用されている模様

### 現状の課題

1. **バージョン管理の欠如**
   - 適用済みマイグレーションの追跡ができない
   - ロールバック機能がない
   - スキーマバージョンが不明

2. **自動化の不足**
   - 手動でマイグレーションコマンドを実行する必要がある
   - 実行順序の保証がない
   - 依存関係の管理ができない

3. **安全性の問題**
   - トランザクション管理が不十分
   - エラー時のロールバックが保証されない
   - データ整合性のチェックが弱い

## 要件定義

### 機能要件

1. **マイグレーション管理**
   - マイグレーションファイルの自動検出
   - 実行順序の保証（タイムスタンプベース）
   - 適用済みマイグレーションの記録
   - 未適用マイグレーションの自動実行

2. **バージョン管理**
   - データベーススキーマバージョンの追跡
   - マイグレーション履歴の保存
   - 現在のバージョン確認機能

3. **安全性**
   - トランザクション内でのマイグレーション実行
   - エラー時の自動ロールバック
   - DryRun機能（実行前の確認）

4. **運用性**
   - コマンドラインツール
   - 実行ログの記録
   - マイグレーション状態の可視化

### 非機能要件

1. **互換性**
   - DuckDBとの完全な互換性
   - 既存データの保護
   - ダウンタイムの最小化

2. **拡張性**
   - 新しいマイグレーションタイプの追加が容易
   - カスタムマイグレーションロジックのサポート
   - プラグイン機構の検討

3. **パフォーマンス**
   - 大規模データに対する効率的な処理
   - インデックス作成の最適化
   - バッチ処理のサポート

## システム設計

### アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                   Migration System                       │
├─────────────────────────────────────────────────────────┤
│  CLI Interface                                          │
│  ├─ migrate up     (未適用マイグレーションを実行)        │
│  ├─ migrate down   (ロールバック)                       │
│  ├─ migrate status (現在の状態確認)                      │
│  └─ migrate create (新規マイグレーション作成)            │
├─────────────────────────────────────────────────────────┤
│  Migration Engine                                       │
│  ├─ File Scanner   (マイグレーションファイル検出)        │
│  ├─ Version Manager (バージョン管理)                     │
│  ├─ Executor       (実行エンジン)                       │
│  └─ Validator      (検証機能)                          │
├─────────────────────────────────────────────────────────┤
│  Storage Layer                                          │
│  ├─ migration_history テーブル                          │
│  └─ schema_version テーブル                            │
└─────────────────────────────────────────────────────────┘
```

### データベーススキーマ

```sql
-- マイグレーション履歴テーブル
CREATE TABLE migration_history (
    id INTEGER PRIMARY KEY,
    version VARCHAR NOT NULL UNIQUE,
    name VARCHAR NOT NULL,
    applied_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    execution_time_ms INTEGER,
    checksum VARCHAR,
    up_script TEXT,
    down_script TEXT,
    status VARCHAR DEFAULT 'success', -- success, failed, pending
    error_message TEXT
);

-- スキーマバージョンテーブル
CREATE TABLE schema_version (
    version VARCHAR PRIMARY KEY,
    dirty BOOLEAN DEFAULT false,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### マイグレーションファイル形式

#### ファイル命名規則
```
{timestamp}_{description}.{up|down}.sql
例: 20250801120000_add_user_preferences_table.up.sql
    20250801120000_add_user_preferences_table.down.sql
```

#### Goマイグレーション形式
```go
// migrations/20250801120000_add_user_preferences.go
package migrations

import (
    "database/sql"
)

func Up_20250801120000(tx *sql.Tx) error {
    // アップマイグレーション処理
    return nil
}

func Down_20250801120000(tx *sql.Tx) error {
    // ダウンマイグレーション処理
    return nil
}
```

### ディレクトリ構造

```
backend/
├── cmd/
│   └── migrate/          # マイグレーションCLI
│       └── main.go
├── internal/
│   ├── migration/        # マイグレーションエンジン
│   │   ├── engine.go
│   │   ├── scanner.go
│   │   ├── executor.go
│   │   ├── validator.go
│   │   └── version.go
│   └── database/
│       └── migration.go  # マイグレーション初期化
└── migrations/           # マイグレーションファイル
    ├── 20250101000000_initial_schema.up.sql
    ├── 20250101000000_initial_schema.down.sql
    └── embed.go          # go:embed でファイルを埋め込み
```

## 実装計画

### フェーズ1: 基盤構築（2週間）

1. **マイグレーションエンジンの実装**
   - ファイルスキャナー
   - バージョン管理
   - 実行エンジン
   - トランザクション管理

2. **履歴管理機能**
   - migration_historyテーブルの実装
   - 適用済みマイグレーションの追跡
   - チェックサム検証

3. **CLIツールの基本機能**
   - migrate up コマンド
   - migrate status コマンド
   - エラーハンドリング

### フェーズ2: 安全性強化（1週間）

1. **検証機能**
   - SQLシンタックスチェック
   - DryRun機能
   - 依存関係チェック

2. **ロールバック機能**
   - migrate down コマンド
   - 部分的ロールバック
   - ロールバック履歴

3. **エラー処理強化**
   - 詳細なエラーログ
   - リカバリー機能
   - アラート機能

### フェーズ3: 運用機能追加（1週間）

1. **マイグレーション作成支援**
   - migrate create コマンド
   - テンプレート生成
   - 命名規則チェック

2. **監視・可視化**
   - マイグレーション状態のWeb UI
   - 実行時間の計測
   - パフォーマンス分析

3. **自動化**
   - サーバー起動時の自動マイグレーション
   - CI/CDとの統合
   - バックアップ連携

## 移行計画

### 既存システムからの移行

1. **準備フェーズ**
   - 現在のスキーマのスナップショット作成
   - 初期マイグレーションファイルの生成
   - 既存の手動マイグレーションツールの分析

2. **移行フェーズ**
   - migration_historyテーブルの初期データ投入
   - 既存スキーマをベースラインとして記録
   - 新システムへの切り替え

3. **検証フェーズ**
   - データ整合性チェック
   - パフォーマンステスト
   - ロールバックテスト

## リスクと対策

### 技術的リスク

1. **DuckDBの制約**
   - 一部のALTER TABLE操作がサポートされない可能性
   - 対策: 事前検証とワークアラウンドの準備

2. **大規模データの処理**
   - マイグレーション時のメモリ使用量
   - 対策: バッチ処理とストリーミング処理の実装

3. **並行実行の問題**
   - 複数インスタンスでの同時マイグレーション
   - 対策: 分散ロック機構の実装

### 運用リスク

1. **ダウンタイム**
   - マイグレーション実行中のサービス停止
   - 対策: オンラインマイグレーション戦略

2. **ロールバックの失敗**
   - データの不可逆的な変更
   - 対策: 完全なバックアップとリストア手順

## 成功基準

1. **機能面**
   - 全ての既存スキーマ変更が新システムで管理可能
   - 自動マイグレーションが正常に動作
   - ロールバック機能が確実に動作

2. **パフォーマンス**
   - マイグレーション実行時間が許容範囲内
   - メモリ使用量が制限内
   - 並行実行時の競合が発生しない

3. **運用面**
   - 開発者が容易に新規マイグレーションを作成可能
   - マイグレーション状態の可視化
   - エラー時の原因特定が容易

## 今後の拡張

1. **マルチデータベース対応**
   - PostgreSQL、MySQL等への対応
   - データベース固有の最適化

2. **高度な機能**
   - データマイグレーション
   - スキーマ差分の自動検出
   - マイグレーションの自動生成

3. **エンタープライズ機能**
   - 承認ワークフロー
   - 監査ログ
   - コンプライアンス対応

## まとめ

本マイグレーションシステムにより、CCDashプロジェクトのデータベーススキーマ管理が大幅に改善される。自動化により開発効率が向上し、履歴管理により変更の追跡が可能となる。また、ロールバック機能により、より安全なデータベース運用が実現できる。

実装は段階的に行い、各フェーズで動作確認を行いながら進める。最終的には、開発者にとって使いやすく、運用チームにとって管理しやすいシステムを目指す。